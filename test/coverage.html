<!DOCTYPE html><html><head><title>Coverage</title><meta charset="utf-8"><script>

headings = [];

onload = function(){
  headings = document.querySelectorAll('h2');
};

onscroll = function(e){
  var heading = find(window.scrollY);
  if (!heading) return;
  var links = document.querySelectorAll('#menu a')
    , link;

  for (var i = 0, len = links.length; i < len; ++i) {
    link = links[i];
    link.className = link.getAttribute('href') == '#' + heading.id
      ? 'active'
      : '';
  }
};

function find(y) {
  var i = headings.length
    , heading;

  while (i--) {
    heading = headings[i];
    if (y >= heading.offsetTop) {
      return heading;
    }
  }
}
</script>
<style>

body {
  font: 14px/1.6 "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: 0;
  color: #2C2C2C;
  border-top: 2px solid #ddd;
}

#coverage {
  padding: 60px;
}

h1 a {
  color: inherit;
  font-weight: inherit;
}

h1 a:hover {
  text-decoration: none;
}

.onload h1 {
  opacity: 1;
}

h2 {
  width: 80%;
  margin-top: 80px;
  margin-bottom: 0;
  font-weight: 100;
  letter-spacing: 1px;
  border-bottom: 1px solid #eee;
}

a {
  color: #8A6343;
  font-weight: bold;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

ul {
  margin-top: 20px;
  padding: 0 15px;
  width: 100%;
}

ul li {
  float: left;
  width: 40%;
  margin-top: 5px;
  margin-right: 60px;
  list-style: none;
  border-bottom: 1px solid #eee;
  padding: 5px 0;
  font-size: 12px;
}

ul::after {
  content: '.';
  height: 0;
  display: block;
  visibility: hidden;
  clear: both;
}

code {
  font: 12px monaco, monospace;
}

pre {
  margin: 30px;
  padding: 30px;
  border: 1px solid #eee;
  border-bottom-color: #ddd;
  -webkit-border-radius: 2px;
  -moz-border-radius: 2px;
  border-radius: 2px;
  -webkit-box-shadow: inset 0 0 10px #eee;
  -moz-box-shadow: inset 0 0 10px #eee;
  box-shadow: inset 0 0 10px #eee;
  overflow-x: auto;
}

img {
  margin: 30px;
  padding: 1px;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  -webkit-box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  -moz-box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  max-width: 100%;
}

footer {
  background: #eee;
  width: 100%;
  padding: 50px 0;
  text-align: right;
  border-top: 1px solid #ddd;
}

footer span {
  display: block;
  margin-right: 30px;
  color: #888;
  font-size: 12px;
}

#menu {
  position: fixed;
  font-size: 12px;
  overflow-y: auto;
  top: 0;
  right: 0;
  margin: 0;
  height: 100%;
  padding: 15px 0;
  text-align: right;
  border-left: 1px solid #eee;
  -moz-box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  -webkit-box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  -webkit-font-smoothing: antialiased;
  background: url("data:image/png;base64,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");
}

#menu::after {
  display: block;
  content: '';
  padding-top: 80px;
}

#logo {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: rgba(255,255,255,.1);
  font-size: 11px;
  display: block;
  width: 20px;
  height: 20px;
  line-height: 20px;
  text-align: center;
  -webkit-border-radius: 20px;
  -moz-border-radius: 20px;
  border-radius: 20px;
  -webkit-box-shadow: 0 0 3px rgba(0,0,0,.2);
  -moz-box-shadow: 0 0 3px rgba(0,0,0,.2);
  box-shadow: 0 0 3px rgba(0,0,0,.2);
  color: inherit;
}

#menu li a {
  display: block;
  color: white;
  padding: 0 35px 0 25px;
  -webkit-transition: background 300ms;
  -moz-transition: background 300ms;
}

#menu li {
  position: relative;
  list-style: none;
}

#menu a:hover,
#menu a.active {
  text-decoration: none;
  background: rgba(255,255,255,.1);
}

#menu li:hover .cov {
  opacity: 1;
}

#menu li .dirname {
  opacity: .60;
  padding-right: 2px;
}

#menu li .basename {
  opacity: 1;
}

#menu .cov {
  background: rgba(0,0,0,.4);
  position: absolute;
  top: 0;
  right: 8px;
  font-size: 9px;
  opacity: .6;
  text-align: left;
  width: 17px;
  -webkit-border-radius: 10px;
  -moz-border-radius: 10px;
  border-radius: 10px;
  padding: 2px 3px;
  text-align: center;
}

#stats:nth-child(2n) {
  display: inline-block;
  margin-top: 15px;
  border: 1px solid #eee;
  padding: 10px;
  -webkit-box-shadow: inset 0 0 2px #eee;
  -moz-box-shadow: inset 0 0 2px #eee;
  box-shadow: inset 0 0 2px #eee;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
  border-radius: 5px;
}

#stats div {
  float: left;
  padding: 0 5px;
}

#stats::after {
  display: block;
  content: '';
  clear: both;
}

#stats .sloc::after {
  content: ' SLOC';
  color: #b6b6b6;
}

#stats .percentage::after {
  content: ' coverage';
  color: #b6b6b6;
}

#stats .hits,
#stats .misses {
  display: none;
}

.high {
  color: #00d4b4;
}
.medium {
  color: #e87d0d;
}
.low {
  color: #d4081a;
}
.terrible {
  color: #d4081a;
  font-weight: bold;
}

table {
  width: 80%;
  margin-top: 10px;
  border-collapse: collapse;
  border: 1px solid #cbcbcb;
  color: #363636;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
}

table thead {
  display: none;
}

table td.line,
table td.hits {
  width: 20px;
  background: #eaeaea;
  text-align: center;
  font-size: 11px;
  padding: 0 10px;
  color: #949494;
}

table td.hits {
  width: 10px;
  padding: 2px 5px;
  color: rgba(0,0,0,.2);
  background: #f0f0f0;
}

tr.miss td.line,
tr.miss td.hits {
  background: #e6c3c7;
}

tr.miss td {
  background: #f8d5d8;
}

td.source {
  padding-left: 15px;
  line-height: 15px;
  white-space: pre;
  font: 12px monaco, monospace;
}

code .comment { color: #ddd }
code .init { color: #2F6FAD }
code .string { color: #5890AD }
code .keyword { color: #8A6343 }
code .number { color: #2F6FAD }
</style>
</head><body><div id="coverage"><h1 id="overview">Coverage</h1><div id="menu"><li><a href="#overview">overview</a></li><li><span class="cov low">27</span><a href="#lib/auth/authorization_provider.js"><span class="dirname">lib/auth/</span><span class="basename">authorization_provider.js</span></a></li><li><span class="cov low">26</span><a href="#lib/core/module.js"><span class="dirname">lib/core/</span><span class="basename">module.js</span></a></li><li><span class="cov high">100</span><a href="#lib/core/params.js"><span class="dirname">lib/core/</span><span class="basename">params.js</span></a></li><li><span class="cov terrible">13</span><a href="#lib/core/resource.js"><span class="dirname">lib/core/</span><span class="basename">resource.js</span></a></li><li><span class="cov terrible">23</span><a href="#lib/core/room.js"><span class="dirname">lib/core/</span><span class="basename">room.js</span></a></li><li><span class="cov low">28</span><a href="#lib/core/route.js"><span class="dirname">lib/core/</span><span class="basename">route.js</span></a></li><li><span class="cov low">33</span><a href="#lib/db/database_provider.js"><span class="dirname">lib/db/</span><span class="basename">database_provider.js</span></a></li><li><span class="cov low">40</span><a href="#lib/ravel.js"><span class="dirname">lib/</span><span class="basename">ravel.js</span></a></li><li><span class="cov high">86</span><a href="#lib/util/application_error.js"><span class="dirname">lib/util/</span><span class="basename">application_error.js</span></a></li><li><span class="cov terrible">11</span><a href="#lib/util/broadcast_middleware.js"><span class="dirname">lib/util/</span><span class="basename">broadcast_middleware.js</span></a></li><li><span class="cov low">27</span><a href="#lib/util/injector.js"><span class="dirname">lib/util/</span><span class="basename">injector.js</span></a></li><li><span class="cov low">36</span><a href="#lib/util/log.js"><span class="dirname">lib/util/</span><span class="basename">log.js</span></a></li><li><span class="cov terrible">7</span><a href="#lib/util/rest.js"><span class="dirname">lib/util/</span><span class="basename">rest.js</span></a></li><a id="logo" href="http://visionmedia.github.io/mocha/">m</a></div><div id="stats" class="low"><div class="percentage">33%</div><div class="sloc">392</div><div class="hits">133</div><div class="misses">259</div></div><div id="files"><div class="file"><h2 id="lib/auth/authorization_provider.js">lib/auth/authorization_provider.js</h2><div id="stats" class="low"><div class="percentage">27%</div><div class="sloc">11</div><div class="hits">3</div><div class="misses">8</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Ravel</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright (c) 2014 Sean McIntyre &lt;s.mcintyre@xverba.ca&gt;</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> * Defines an abstract AuthorizationProvider - a module</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> * which is capable of initializing Passport.js with</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * a particular OAuth2 strategy, and seamlessly verifying</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * requests issued by mobile clients via OAuth2 tokens</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> * instead of sessions.</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">module.exports = function(Ravel) {</td></tr><tr class="hit"><td class="line">14</td><td class="hits">7</td><td class="source">  Ravel.AuthorizationProvider = function(name) {</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">     * The name of the AuthorizationProvider</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">     */</td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">    this.name = name;</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">     * Initialize passport.js with a strategy</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">     * @param expressApp {Object} An express application object</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">     * @param passport {Object} A passport.js object</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">     * @param verify {Function} See passport.js Strategy verify callback.</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">     *                          Just pass this to the strategy you create</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">     *                          and activate via passport.use.</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">     */</td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">    this.init = function() {</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">      throw new Ravel.ApplicationError.NotImplemented('AuthorizationProvider ' + this.name + ' must implement init(expressApp, passport, verify)');</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">     * End a transaction depending on finalErr and close the connection.</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">     * Rollback the transaction iff finalErr !== null.</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">     * @param client {String} A client type, such as google-oauth2-ios</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">     * @return {Boolean} true iff this provider handles the given client</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">     */</td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">    this.handlesClient = function() {</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">      throw new Ravel.ApplicationError.NotImplemented('AuthorizationProvider ' + this.name + ' must implement handlesClient(connection, finalErr, callback)');</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">     * Transform an OAuth2 token into a user profile, iff the</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">     * token is valid for this application.</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">     * @param token {String} An OAuth2 user token</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">     * @param client {String}  A client type, such as google-oauth2-ios</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">     * @param callback {Function} Node.js callback(err, profile, expiry)</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">     */</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">    this.tokenToProfile = function() {</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">      throw new Ravel.ApplicationError.NotImplemented('AuthorizationProvider ' + this.name + ' must implement tokenToProfile(token, client, callback)');</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">    return this;</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="lib/core/module.js">lib/core/module.js</h2><div id="stats" class="low"><div class="percentage">26%</div><div class="sloc">15</div><div class="hits">4</div><div class="misses">11</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Ravel</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright (c) 2014 Sean McIntyre &lt;s.mcintyre@xverba.ca&gt;</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> * Provides Ravel with a simple mechanism of registering</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> * user-defined modules and connecting them, via</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * injector.js, with dependency injection</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">var path = require('path');</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">module.exports = function(Ravel, moduleFactories, injector) {</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">   * Register a module with Ravel</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">   * A module is a pure node.js javascript API consisting of functions with no</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">   * network-related functionality, suitable for unit-testing.</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">   * Module should use injection to get what it needs</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">   * @param {String} name The name of the module</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">   * @param {String} modulePath The path to the module</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">27</td><td class="hits">7</td><td class="source">  Ravel.module = function(name, modulePath) {</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">  //if a module with this name has already been regsitered, error out</td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">  if (moduleFactories[name]) {</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">    throw new Ravel.ApplicationError.DuplicateEntry('Module with name \'' + name + '\' has already been registered.');</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">  var module = {};</td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">  var methodBuilder = {</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">    add: function(methodName, handler) {</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">      if (module[methodName]) {</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">        throw new Ravel.ApplicationError.DuplicateEntry('Method with name \'' + methodName + '\' has already been registered.');</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">        module[methodName] = handler;</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">  //save uninitialized module to Ravel.modules</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">  //so that it can be injected into other</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">  //modules and lazily instantiated</td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="source">  Ravel.modules[name] = module;</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">  //build module instantiation function</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">  moduleFactories[name] = function() {</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">    var moduleInject = require(path.join(Ravel.cwd, modulePath));</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">    injector.inject({</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">      '$L': require('../util/log')(name),</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">      '$MethodBuilder': methodBuilder,</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">      '$KV': Ravel.kvstore</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">    },moduleInject);</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="lib/core/params.js">lib/core/params.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">17</div><div class="hits">17</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Ravel</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright (c) 2014 Sean McIntyre &lt;s.mcintyre@xverba.ca&gt;</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> * A lightweight configuration system for Ravel, allowing</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> * clients, as well as other parts of the application, to</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * define expected configuration parameters and get/set</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * their values</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source"> module.exports = function(Ravel, knownParameters, params) {</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">   /**</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">   * Register a parameter</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">   * @param {String} key the key for the parameter</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">   * @param {Boolean | undefined} required true, iff the parameter is required</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">19</td><td class="hits">7</td><td class="source">  Ravel.registerSimpleParameter = function(key, required) {</td></tr><tr class="hit"><td class="line">20</td><td class="hits">145</td><td class="source">    knownParameters[key] = {</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">      required: required</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">   * Get a parameter</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">   * @param {String} key the key for the parameter</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">   * @throws ApplicationError.NotFound if the parameter is required and not set</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">   * @return {? | undefined} the parameter value, or undefined if it is not required and not set</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">32</td><td class="hits">7</td><td class="source">  Ravel.get = function(key) {</td></tr><tr class="hit"><td class="line">33</td><td class="hits">6</td><td class="source">    if (!knownParameters[key]) {</td></tr><tr class="hit"><td class="line">34</td><td class="hits">1</td><td class="source">      throw new Ravel.ApplicationError.NotFound('Parameter \'' + key + '\' was requested, but is unknown.');</td></tr><tr class="hit"><td class="line">35</td><td class="hits">5</td><td class="source">    } else if (knownParameters[key].required &amp;&amp; params[key] === undefined) {</td></tr><tr class="hit"><td class="line">36</td><td class="hits">1</td><td class="source">      throw new Ravel.ApplicationError.NotFound('Known required parameter \'' + key + '\' was requested, but hasn\'t been defined yet.');</td></tr><tr class="hit"><td class="line">37</td><td class="hits">4</td><td class="source">    } else if (params[key] === undefined) {</td></tr><tr class="hit"><td class="line">38</td><td class="hits">1</td><td class="source">      Ravel.Log.l('Optional parameter \'' + key + '\' was requested, but is not defined.');</td></tr><tr class="hit"><td class="line">39</td><td class="hits">1</td><td class="source">      return undefined;</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">41</td><td class="hits">3</td><td class="source">      return params[key];</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">   * Set a parameter</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">   * @param {String} key the key for the parameter</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">   * @param {?} value the value for the parameter</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">   * @throws ApplicationError.IllegalValue if key refers to an unregistered parameter</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">   * @return {?} the parameter value</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">53</td><td class="hits">7</td><td class="source">  Ravel.set = function(key, value) {</td></tr><tr class="hit"><td class="line">54</td><td class="hits">18</td><td class="source">    if (knownParameters[key]) {</td></tr><tr class="hit"><td class="line">55</td><td class="hits">17</td><td class="source">      params[key] = value;</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">57</td><td class="hits">1</td><td class="source">      throw new Ravel.ApplicationError.IllegalValue('Parameter \'' + key + '\' is not supported.');</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> };</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="lib/core/resource.js">lib/core/resource.js</h2><div id="stats" class="terrible"><div class="percentage">13%</div><div class="sloc">46</div><div class="hits">6</div><div class="misses">40</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Ravel</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright (c) 2014 Sean McIntyre &lt;s.mcintyre@xverba.ca&gt;</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> * Provides Ravel with a mechanism to register a RESTful</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> * resource, and gives the client the ability to define</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * up to 7 methods on that resource endpoint (GET, POST,</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * PUT, DELETE, GET all, PUT all, DELETE all).</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> * Also supports, via broadcast_middleware.js, the</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> * publishing of messages to clients in specific</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> * websocket rooms (based on the path of the resource)</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> * concerning events which have occurred at this endpoint</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> * (such as the creation of a new record or the alteration</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> * of an existing one).</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">var path = require('path');</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">module.exports = function(Ravel, resourceFactories, injector) {</td></tr><tr class="hit"><td class="line">24</td><td class="hits">7</td><td class="source">  var rest = require('../util/rest')(Ravel);</td></tr><tr class="hit"><td class="line">25</td><td class="hits">7</td><td class="source">  var broadcastMiddleware = require('../util/broadcast_middleware')(Ravel);</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">   * Register a RESTful resource with Ravel</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">   * A resource is a set of RESTful endpoints for a single Resource</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">   * @param {String} basePath The base path of the all the Resource's endpoints</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">   * @param {String} resourcePath the path of the resource module to require(...)</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">36</td><td class="hits">7</td><td class="source">  Ravel.resource = function(basePath, resourcePath) {</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">    basePath = path.normalize(basePath);</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">    //if a resource with this name has already been regsitered, error out</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">    if (resourceFactories[basePath]) {</td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">      throw new Ravel.ApplicationError.DuplicateEntry('Resource with name \'' + basePath + '\' has already been registered.');</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">    //Build EndpointBuilder service, which will facilitate public</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">    //endpoints like $EndpointBuilder.getAll(...), or private ones</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">    //via $EndpointBuilder.getAll($Private, ...)</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">    var endpointBuilder = {</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">      _methods: {}</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">    };</td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="source">    var addMethod = function(obj, method) {</td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">      obj[method] = function() {</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">        //all arguments are express middleware of the form function(req, res, next?)</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">        var middleware = Array.prototype.slice.call(arguments, 0);</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">        if (endpointBuilder._methods[method]) {</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">          throw new Ravel.ApplicationError.DuplicateEntry('Method '+method+' has already been registered with resource \''+basePath+'\'');</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">          endpointBuilder._methods[method] = {</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">            middleware: middleware</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">          };</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">          return endpointBuilder;</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">      };</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">    };</td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="source">    addMethod(endpointBuilder, 'getAll');</td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="source">    addMethod(endpointBuilder, 'putAll');</td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="source">    addMethod(endpointBuilder, 'deleteAll');</td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="source">    addMethod(endpointBuilder, 'get');</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">    addMethod(endpointBuilder, 'post');</td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="source">    addMethod(endpointBuilder, 'put');</td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="source">    addMethod(endpointBuilder, 'delete');</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">    //build service instantiation function</td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="source">    resourceFactories[basePath] = function(expressApp) {</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">      var resourceInject = require(path.join(Ravel.cwd, resourcePath));</td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="source">      injector.inject({</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">        '$L': require('../util/log')(basePath),</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">        '$EndpointBuilder': endpointBuilder,</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">        '$Rest': rest,</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">        '$KV': Ravel.kvstore,</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">        '$Broadcast': Ravel.broadcast,</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">        '$MiddlewareTransaction': Ravel.db.middleware,</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">        '$Private': Ravel.authorize,</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">        '$PrivateRedirect': Ravel.authorizeWithRedirect</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">      }, resourceInject);</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">      //process all methods and add to express app</td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="source">      var buildRoute = function(methodType, methodName) {</td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="source">        var bp = basePath;</td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="source">        if (methodName === 'get' || methodName === 'put' || methodName === 'delete') {</td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="source">          bp = path.join(basePath, '/:id');</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="source">        var args = [bp];</td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="source">        if (endpointBuilder._methods[methodName]) {</td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="source">          Ravel.Log.i('Registering resource endpoint ' + methodType.toUpperCase() + ' ' + bp);</td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="source">          args.push(broadcastMiddleware);</td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="source">          args = args.concat(endpointBuilder._methods[methodName].middleware);</td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="source">          expressApp[methodType].apply(expressApp, args);</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">        } else {</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">          //Ravel.Log.i('Registering unimplemented resource endpoint ' + methodType.toUpperCase() + ' ' + bp);</td></tr><tr class="miss"><td class="line">97</td><td class="hits">0</td><td class="source">          expressApp[methodType](bp, function(req, res) {</td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="source">            res.status(rest.NOT_IMPLEMENTED).end();</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">          });</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">      };</td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="source">      buildRoute('get', 'getAll');</td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="source">      buildRoute('put', 'putAll');</td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="source">      buildRoute('delete', 'deleteAll');</td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="source">      buildRoute('get', 'get');</td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="source">      buildRoute('post', 'post');</td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="source">      buildRoute('put', 'put');</td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="source">      buildRoute('delete', 'delete');</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="lib/core/room.js">lib/core/room.js</h2><div id="stats" class="terrible"><div class="percentage">23%</div><div class="sloc">17</div><div class="hits">4</div><div class="misses">13</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Ravel</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright (c) 2014 Sean McIntyre &lt;s.mcintyre@xverba.ca&gt;</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> * Allows clients to define websocket rooms, which take</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> * an authorization function. Rooms are structured as</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * paths with optional path parameters which, if present,</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * are supplied to the authorization function. Thus</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> * this module can actually be used to define groups of</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> * rooms which share a common path structure.</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">var path = require('path');</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">module.exports = function(Ravel, rooms) {</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">   /**</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">   * Registers a websocket room, with a given authorization function and context</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">   * @param {String} roomPattern the name of the websocket room</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">   * @param {Function} authorizationFunction, of the form function(userId, callback(err, {Boolean}authorized))</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">24</td><td class="hits">7</td><td class="source">  Ravel.room = function(roomPattern, authorizationFunction) {</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">    roomPattern = path.normalize(roomPattern);</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    //if a room with this name has already been regsitered, error out</td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="source">    if (rooms[roomPattern]) {</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">      throw new Ravel.ApplicationError.DuplicateEntry('Websocket room with path \'' + roomPattern + '\' has already been registered.');</td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">    } else if (typeof authorizationFunction !== 'function') {</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">      throw new Ravel.ApplicationError.IllegalValue('Authorization function for path \'' + roomPattern + '\' must be a function.');</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">    }</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">    var params = [];</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">    var paramMatcher = new RegExp(/\:(\w+)/g);</td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">    var paramMatch = paramMatcher.exec(roomPattern);</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">    while (paramMatch !== null) {</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">      params.push(paramMatch[1]);</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">      paramMatch = paramMatcher.exec(roomPattern);</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">    }</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">    rooms[roomPattern] = {</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">      name: roomPattern,</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">      params: params,</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">      regex: new RegExp(roomPattern.replace(/\:(\w+)/g,'(\\w+)')),</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">      authorize: authorizationFunction</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">    };</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">    Ravel.Log.i('Creating websocket room with pattern ' + roomPattern);</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> };</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="lib/core/route.js">lib/core/route.js</h2><div id="stats" class="low"><div class="percentage">28%</div><div class="sloc">14</div><div class="hits">4</div><div class="misses">10</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Ravel</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright (c) 2014 Sean McIntyre &lt;s.mcintyre@xverba.ca&gt;</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> * Provides Ravel with a simple mechanism of registering</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> * ExpressJS routes, which should generally only be used</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * for serving templated pages or static content (not</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * for building RESTful APIs, for which Ravel.resource</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> * is more applicable). Thus, these routes are restricted</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> * to GET-only requests.</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">var path = require('path');</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">module.exports = function(Ravel, routesFactories, injector) {</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">   * Register a bunch of plain GET express middleware (ejs, static, etc.)</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">   * with Ravel which will be available, by name, at the given</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">   * base path.</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">   * @param {String} directoryModulePath the path of the directory module to require(...)</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">25</td><td class="hits">7</td><td class="source">  Ravel.routes = function(routeModulePath) {</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    //if a module with this name has already been regsitered, error out</td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="source">    if (routesFactories[routeModulePath]) {</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">      throw new Ravel.ApplicationError.DuplicateEntry('Route module \'' + routeModulePath + '\' has already been registered.');</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    }</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">    var routes = {</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">      _routes: []</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">    };</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">    var routeBuilder = {</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">      add: function(route, middleware) {</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">        routes._routes.push({</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">          route:route,</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">          middleware:middleware</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">    //This will be run in Ravel.start</td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">    routesFactories[routeModulePath] = function(expressApp) {</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">      injector.inject({</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">        '$L': require('../util/log')(routeModulePath),</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">        '$RouteBuilder': routeBuilder,</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        '$Broadcast': Ravel.broadcast,</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        '$KV': Ravel.kvstore,</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">        '$Private': Ravel.authorize,</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">        '$PrivateRedirect': Ravel.authorizeWithRedirect</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">      }, require(path.join(Ravel.cwd, routeModulePath)));</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">      for (var rk=0;rk&lt;routes._routes.length;rk++) {</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">        Ravel.Log.i('Registering route GET ' + routes._routes[rk].route);</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">        expressApp.get(routes._routes[rk].route, routes._routes[rk].middleware);</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="lib/db/database_provider.js">lib/db/database_provider.js</h2><div id="stats" class="low"><div class="percentage">33%</div><div class="sloc">9</div><div class="hits">3</div><div class="misses">6</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Ravel</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright (c) 2014 Sean McIntyre &lt;s.mcintyre@xverba.ca&gt;</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> * Defines an abstract DatabaseProvider - a mechanism</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * by which connections can be obtained and transactions</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * can be entered and exited for a particular database</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> * provider such as MySQL (see db/mysql.js for an</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> * example implementation).</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">module.exports = function(Ravel) {</td></tr><tr class="hit"><td class="line">15</td><td class="hits">7</td><td class="source">  Ravel.DatabaseProvider = function(name) {</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">     * The name of the DatabaseProvider</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">     */</td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">    this.name = name;</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">     * Obtain a connection and start a transaction</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">     * @param callback {Function} callback(err, connection)</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">     */</td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">    this.getTransactionConnection = function() {</td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="source">      throw new Ravel.ApplicationError.NotImplemented('DatabaseProvider ' + this.name + ' must implement getTransactionConnection(callback)');</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">     * End a transaction depending on finalErr and close the connection.</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">     * Rollback the transaction iff finalErr !== null.</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">     * @param connection {Object} A connection object which was used throughout the transaction</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">     * @param shouldCommit {Boolean} If true, commit, otherwise rollback</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">     * @param callback {Function} callback(exitErr)</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">     */</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">    this.exitTransaction = function() {</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">      throw new Ravel.ApplicationError.NotImplemented('DatabaseProvider ' + this.name + ' must implement exitTransaction(connection, shouldCommit, callback)');</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    };</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">    return this;</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="lib/ravel.js">lib/ravel.js</h2><div id="stats" class="low"><div class="percentage">40%</div><div class="sloc">109</div><div class="hits">44</div><div class="misses">65</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * This module provides Ravel, a lightweight framework</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * for the rapid creation of MVPs which scale horizontally</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * with ease and support the latest in web technology.</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">module.exports = function() {</td></tr><tr class="hit"><td class="line">9</td><td class="hits">7</td><td class="source">  var Ravel = {</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">    modules: {},</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">    ApplicationError:require('./util/application_error'),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">    Log:require('./util/log')('ravel'),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    //current working directory of the app using the</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    //ravel library, so that client modules can be</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    //loaded with relative paths.</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    cwd: process.cwd()</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">  };</td></tr><tr class="hit"><td class="line">18</td><td class="hits">7</td><td class="source">  var moduleFactories = {};</td></tr><tr class="hit"><td class="line">19</td><td class="hits">7</td><td class="source">  var resourceFactories = {};</td></tr><tr class="hit"><td class="line">20</td><td class="hits">7</td><td class="source">  var routesFactories = {};</td></tr><tr class="hit"><td class="line">21</td><td class="hits">7</td><td class="source">  var rooms = {};</td></tr><tr class="hit"><td class="line">22</td><td class="hits">7</td><td class="source">  var knownParameters = {};</td></tr><tr class="hit"><td class="line">23</td><td class="hits">7</td><td class="source">  var params = {};</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">  //set up core event emitter</td></tr><tr class="hit"><td class="line">26</td><td class="hits">7</td><td class="source">  Ravel._eventEmitter = new (require('events')).EventEmitter();</td></tr><tr class="hit"><td class="line">27</td><td class="hits">7</td><td class="source">  Ravel.on = function(e, func) {</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">    Ravel._eventEmitter.on(e, func);</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">  //init database provider prototype</td></tr><tr class="hit"><td class="line">32</td><td class="hits">7</td><td class="source">  require('./db/database_provider')(Ravel);</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">  //init authorization provider prototype</td></tr><tr class="hit"><td class="line">34</td><td class="hits">7</td><td class="source">  require('./auth/authorization_provider')(Ravel);</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">  //init parameter system</td></tr><tr class="hit"><td class="line">36</td><td class="hits">7</td><td class="source">  require('./core/params')(Ravel, knownParameters, params);</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">  //init dependency injection utility, which is used by most everything else</td></tr><tr class="hit"><td class="line">39</td><td class="hits">7</td><td class="source">  var injector = require('./util/injector')(Ravel, moduleFactories, module.parent);</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">  //init module registration (Ravel.module)</td></tr><tr class="hit"><td class="line">42</td><td class="hits">7</td><td class="source">  require('./core/module')(Ravel, moduleFactories, injector);</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">  //init routes registration (Ravel.routes)</td></tr><tr class="hit"><td class="line">45</td><td class="hits">7</td><td class="source">  require('./core/route')(Ravel, routesFactories, injector);</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">  //init resource registration (Ravel.resource)</td></tr><tr class="hit"><td class="line">48</td><td class="hits">7</td><td class="source">  require('./core/resource')(Ravel, resourceFactories, injector);</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">  //init websocket room registration (Ravel.room)</td></tr><tr class="hit"><td class="line">51</td><td class="hits">7</td><td class="source">  require('./core/room')(Ravel, rooms);</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">   * Much like start(), but only initializes modules for</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">   * testing purposes. Resources, routes and rooms are</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">   * not initialized, and no web server is started.</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">58</td><td class="hits">7</td><td class="source">  Ravel.test = function() {</td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">    Ravel._eventEmitter.emit('start');</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">    Ravel.db = require('./db/database')(Ravel);</td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">    Ravel.set('always rollback transactions', true);</td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="source">    Ravel.kvstore = require('./util/kvstore')('ravel_prefix', Ravel);</td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="source">    Ravel.kvstore.flushdb();</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">    //create registered modules using factories</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">    for (var moduleName in moduleFactories) {</td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="source">      moduleFactories[moduleName]();</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">   * Starts the application, when the client is finished</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">   * supplying parameters and registering modules, resources</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">   * routes and rooms.</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">76</td><td class="hits">7</td><td class="source">  Ravel.start = function() {</td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="source">    Ravel._eventEmitter.emit('start');</td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="source">    Ravel.db = require('./db/database')(Ravel);</td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">    Ravel.kvstore = require('./util/kvstore')('ravel_prefix', Ravel);</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">    //App dependencies.</td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="source">    var express = require('express');</td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="source">    var session = require('express-session');</td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="source">    var compression = require('compression');</td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="source">    var favicon = require('serve-favicon');</td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="source">    var cookieParser = require('cookie-parser');</td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="source">    var http = require('http'); //https will be provided by reverse proxy</td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="source">    var path = require('path');</td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="source">    var passport = require('passport');</td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="source">    var Primus = require('primus.io');</td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="source">    var ExpressRedisStore = require('connect-redis')(session);</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">    //configure express</td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="source">    var app = express();</td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="source">    app.disable('x-powered-by');</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">    //configure redis session store</td></tr><tr class="miss"><td class="line">97</td><td class="hits">0</td><td class="source">    var sessionStoreArgs = {</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">      host:Ravel.get('redis host'),</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">      port:Ravel.get('redis port'),</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">      db:0 //we stick to 0 because clustered redis doesn't support multiple dbs</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">    };</td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="source">    if (Ravel.get('redis password')) {</td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="source">      sessionStoreArgs.pass = Ravel.get('redis password');</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">    }</td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="source">    var expressSessionStore = new ExpressRedisStore(sessionStoreArgs);</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="source">    app.set('domain', Ravel.get('node domain'));</td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="source">    app.set('port', Ravel.get('node port'));</td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="source">    app.set('app domain', Ravel.get('app domain'));</td></tr><tr class="miss"><td class="line">110</td><td class="hits">0</td><td class="source">    app.set('app port', Ravel.get('app port'));</td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="source">    app.enable('trust proxy');</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">    //configure views</td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="source">    app.set('views', path.join(Ravel.cwd, Ravel.get('express view directory')));</td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="source">    app.set('view engine', Ravel.get('express view engine'));</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">    //app.use(require('morgan')('dev')); //uncomment to see HTTP requests</td></tr><tr class="miss"><td class="line">116</td><td class="hits">0</td><td class="source">    app.use(compression());</td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="source">    if (Ravel.get('express favicon path')) {</td></tr><tr class="miss"><td class="line">118</td><td class="hits">0</td><td class="source">      app.use(favicon(path.join(Ravel.cwd, Ravel.get('express favicon path'))));</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">    }</td></tr><tr class="miss"><td class="line">120</td><td class="hits">0</td><td class="source">    app.use(require('body-parser').json());</td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="source">    app.use(require('method-override')());</td></tr><tr class="miss"><td class="line">122</td><td class="hits">0</td><td class="source">    app.use(cookieParser(Ravel.get('express session secret')));</td></tr><tr class="miss"><td class="line">123</td><td class="hits">0</td><td class="source">    app.use(session({</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">      store: expressSessionStore,</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">      secret:Ravel.get('express session secret'),</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">      resave:true,</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">      saveUninitialized:true</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">    }));</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">    //cross-site scripting protection, with mobile app support</td></tr><tr class="miss"><td class="line">130</td><td class="hits">0</td><td class="source">    app.use(require('./auth/csrf')(Ravel));</td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="source">    app.use(function(req, res, next){</td></tr><tr class="miss"><td class="line">132</td><td class="hits">0</td><td class="source">      if (req.csrfToken) {</td></tr><tr class="miss"><td class="line">133</td><td class="hits">0</td><td class="source">        res.locals.token = req.csrfToken();</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">135</td><td class="hits">0</td><td class="source">      next();</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">    });</td></tr><tr class="miss"><td class="line">137</td><td class="hits">0</td><td class="source">    app.use(express.static(path.join(Ravel.cwd, Ravel.get('express public directory'))));</td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="source">    app.use(require('connect-flash')());</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">    //initialize passport authentication</td></tr><tr class="miss"><td class="line">141</td><td class="hits">0</td><td class="source">    app.use(passport.initialize());</td></tr><tr class="miss"><td class="line">142</td><td class="hits">0</td><td class="source">    app.use(passport.session());</td></tr><tr class="miss"><td class="line">143</td><td class="hits">0</td><td class="source">    require('./auth/passport_init.js')(Ravel, app, injector, passport);</td></tr><tr class="miss"><td class="line">144</td><td class="hits">0</td><td class="source">    Ravel.authorize = require('./auth/authorize_request')(Ravel, false, true);</td></tr><tr class="miss"><td class="line">145</td><td class="hits">0</td><td class="source">    Ravel.authorizeWithRedirect = require('./auth/authorize_request')(Ravel, true, true);</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">    //Create ExpressJS server</td></tr><tr class="miss"><td class="line">148</td><td class="hits">0</td><td class="source">    var server = http.createServer(app);</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">    //Pass server to Primus to get it going on the same port</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">    //Initialize primus.io with room handling, etc.</td></tr><tr class="miss"><td class="line">152</td><td class="hits">0</td><td class="source">    var primus = new Primus(server, { transformer: 'websockets', parser: 'JSON' });</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">    //primus_init produces a configured, cluster-ready broadcasting library</td></tr><tr class="miss"><td class="line">154</td><td class="hits">0</td><td class="source">    var broadcast = require('./auth/primus_init.js')(Ravel, primus, expressSessionStore, require('./util/websocket_room_resolver')(rooms));</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">    //public version of broadcast, for client use</td></tr><tr class="miss"><td class="line">156</td><td class="hits">0</td><td class="source">    Ravel.broadcast = {</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">      emit: broadcast.emit</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">    //create registered modules using factories</td></tr><tr class="miss"><td class="line">161</td><td class="hits">0</td><td class="source">    for (var moduleName in moduleFactories) {</td></tr><tr class="miss"><td class="line">162</td><td class="hits">0</td><td class="source">      moduleFactories[moduleName]();</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">    //create registered resources using factories</td></tr><tr class="miss"><td class="line">166</td><td class="hits">0</td><td class="source">    for (var resourceName in resourceFactories) {</td></tr><tr class="miss"><td class="line">167</td><td class="hits">0</td><td class="source">      resourceFactories[resourceName](app);</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">    //create routes using factories</td></tr><tr class="miss"><td class="line">171</td><td class="hits">0</td><td class="source">    for (var routesName in routesFactories) {</td></tr><tr class="miss"><td class="line">172</td><td class="hits">0</td><td class="source">      routesFactories[routesName](app);</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">    //Start ExpressJS server</td></tr><tr class="miss"><td class="line">176</td><td class="hits">0</td><td class="source">    server.listen(Ravel.get('node port'), function(){</td></tr><tr class="miss"><td class="line">177</td><td class="hits">0</td><td class="source">      Ravel.Log.i('Application server at ' + Ravel.get('node domain') + ' listening on port ' + Ravel.get('node port'));</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">  //Register known ravel parameters</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">  //database providers</td></tr><tr class="hit"><td class="line">183</td><td class="hits">7</td><td class="source">  Ravel.registerSimpleParameter('database providers', true);</td></tr><tr class="hit"><td class="line">184</td><td class="hits">7</td><td class="source">  Ravel.set('database providers', []);</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">  //authorization providers</td></tr><tr class="hit"><td class="line">186</td><td class="hits">7</td><td class="source">  Ravel.registerSimpleParameter('authorization providers', true);</td></tr><tr class="hit"><td class="line">187</td><td class="hits">7</td><td class="source">  Ravel.set('authorization providers', []);</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">  //redis parameters</td></tr><tr class="hit"><td class="line">189</td><td class="hits">7</td><td class="source">  Ravel.registerSimpleParameter('redis host', true);</td></tr><tr class="hit"><td class="line">190</td><td class="hits">7</td><td class="source">  Ravel.registerSimpleParameter('redis port', true);</td></tr><tr class="hit"><td class="line">191</td><td class="hits">7</td><td class="source">  Ravel.registerSimpleParameter('redis password');</td></tr><tr class="hit"><td class="line">192</td><td class="hits">7</td><td class="source">  Ravel.registerSimpleParameter('websocket message cache time');</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">  //Node/express parameters</td></tr><tr class="hit"><td class="line">194</td><td class="hits">7</td><td class="source">  Ravel.registerSimpleParameter('app domain', true);</td></tr><tr class="hit"><td class="line">195</td><td class="hits">7</td><td class="source">  Ravel.registerSimpleParameter('app port', true);</td></tr><tr class="hit"><td class="line">196</td><td class="hits">7</td><td class="source">  Ravel.registerSimpleParameter('node domain', true);</td></tr><tr class="hit"><td class="line">197</td><td class="hits">7</td><td class="source">  Ravel.registerSimpleParameter('node port', true);</td></tr><tr class="hit"><td class="line">198</td><td class="hits">7</td><td class="source">  Ravel.registerSimpleParameter('express public directory', true);</td></tr><tr class="hit"><td class="line">199</td><td class="hits">7</td><td class="source">  Ravel.registerSimpleParameter('express view directory', true);</td></tr><tr class="hit"><td class="line">200</td><td class="hits">7</td><td class="source">  Ravel.registerSimpleParameter('express view engine', true);</td></tr><tr class="hit"><td class="line">201</td><td class="hits">7</td><td class="source">  Ravel.registerSimpleParameter('express favicon path');</td></tr><tr class="hit"><td class="line">202</td><td class="hits">7</td><td class="source">  Ravel.registerSimpleParameter('express session secret', true);</td></tr><tr class="hit"><td class="line">203</td><td class="hits">7</td><td class="source">  Ravel.registerSimpleParameter('disable json vulnerability protection');</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">  //Passport parameters</td></tr><tr class="hit"><td class="line">205</td><td class="hits">7</td><td class="source">  Ravel.registerSimpleParameter('app route', true);</td></tr><tr class="hit"><td class="line">206</td><td class="hits">7</td><td class="source">  Ravel.registerSimpleParameter('login route', true);</td></tr><tr class="hit"><td class="line">207</td><td class="hits">7</td><td class="source">  Ravel.registerSimpleParameter('get user function', true);</td></tr><tr class="hit"><td class="line">208</td><td class="hits">7</td><td class="source">  Ravel.registerSimpleParameter('get or create user function', true);</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">210</td><td class="hits">7</td><td class="source">  return Ravel;</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="lib/util/application_error.js">lib/util/application_error.js</h2><div id="stats" class="high"><div class="percentage">86%</div><div class="sloc">36</div><div class="hits">31</div><div class="misses">5</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Ravel</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright (c) 2013 Sean McIntyre &lt;s.mcintyre@xverba.ca&gt;</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> * Error types for Ravel, to be used within Ravel modules,</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> * as well as by clients' APIs. These Error types are intended</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * to encapsulate standard things that can go wrong and, when</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * used by a client, are translated into HTTP status codes</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> * automatically in resource responses (see rest.js).</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> * Thanks to http://dustinsenos.com/articles/customErrorsInNode</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">var util = require('util');</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">var AbstractError = function (msg, constr) {</td></tr><tr class="hit"><td class="line">19</td><td class="hits">3</td><td class="source">  Error.captureStackTrace(this, constr || this);</td></tr><tr class="hit"><td class="line">20</td><td class="hits">3</td><td class="source">  this.message = msg || 'Error';</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">};</td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">util.inherits(AbstractError, Error);</td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">AbstractError.prototype.name = 'Abstract Error';</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> * Access Error - Thrown when a user attempts to utilize functionality they are</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> * not authorized to access due to lack of workspace membership</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> * @param {String} msg A string representation of this AccessError</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">31</td><td class="hits">1</td><td class="source">var AccessError = function (msg) {</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">  AccessError.super_.call(this, msg, this.constructor);</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">};</td></tr><tr class="hit"><td class="line">34</td><td class="hits">1</td><td class="source">util.inherits(AccessError, AbstractError);</td></tr><tr class="hit"><td class="line">35</td><td class="hits">1</td><td class="source">AccessError.prototype.name = 'Access Error';</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> * Duplicate Entry Error - Thrown when an attempt is made to insert a record</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> * into the database which violates a uniqueness constraint</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> * @param {String} msg A string representation of this DuplicateEntryError</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">43</td><td class="hits">1</td><td class="source">var DuplicateEntryError = function (msg) {</td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">  DuplicateEntryError.super_.call(this, msg, this.constructor);</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">};</td></tr><tr class="hit"><td class="line">46</td><td class="hits">1</td><td class="source">util.inherits(DuplicateEntryError, AbstractError);</td></tr><tr class="hit"><td class="line">47</td><td class="hits">1</td><td class="source">DuplicateEntryError.prototype.name = 'Duplicate Entry Error';</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> * Illegal Value Error - Thrown when the user supplies an illegal value</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> * @param {String} msg A string representation of this IllegalValueError</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">54</td><td class="hits">1</td><td class="source">var IllegalValueError = function (msg) {</td></tr><tr class="hit"><td class="line">55</td><td class="hits">1</td><td class="source">  IllegalValueError.super_.call(this, msg, this.constructor);</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">};</td></tr><tr class="hit"><td class="line">57</td><td class="hits">1</td><td class="source">util.inherits(IllegalValueError, AbstractError);</td></tr><tr class="hit"><td class="line">58</td><td class="hits">1</td><td class="source">IllegalValueError.prototype.name = 'Illegal Value Error';</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> * Not Allowed Error - Used to mark API functionality which is not permitted</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> * to be accessed under the current application configuration</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> * @param {String} msg A string representation of this NotAllowedError</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">66</td><td class="hits">1</td><td class="source">var NotAllowedError = function (msg) {</td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="source">  NotAllowedError.super_.call(this, msg, this.constructor);</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">};</td></tr><tr class="hit"><td class="line">69</td><td class="hits">1</td><td class="source">util.inherits(NotAllowedError, AbstractError);</td></tr><tr class="hit"><td class="line">70</td><td class="hits">1</td><td class="source">NotAllowedError.prototype.name = 'Not Allowed Error';</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> * Not Found Error - Thrown when a record is expected to exist in the ravel</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> * database, but is not found.</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> * @param {String} msg A string representation of this NotFoundError</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">78</td><td class="hits">1</td><td class="source">var NotFoundError = function (msg) {</td></tr><tr class="hit"><td class="line">79</td><td class="hits">2</td><td class="source">  NotFoundError.super_.call(this, msg, this.constructor);</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">};</td></tr><tr class="hit"><td class="line">81</td><td class="hits">1</td><td class="source">util.inherits(NotFoundError, AbstractError);</td></tr><tr class="hit"><td class="line">82</td><td class="hits">1</td><td class="source">NotFoundError.prototype.name = 'Not Found Error';</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source"> * Not Implemented Error - Used to mark API functionality which has not yet</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source"> * been implemented</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source"> * @param {String} msg A string representation of this NotImplementedError</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">91</td><td class="hits">1</td><td class="source">var NotImplementedError = function (msg) {</td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="source">  NotImplementedError.super_.call(this, msg, this.constructor);</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">};</td></tr><tr class="hit"><td class="line">94</td><td class="hits">1</td><td class="source">util.inherits(NotImplementedError, AbstractError);</td></tr><tr class="hit"><td class="line">95</td><td class="hits">1</td><td class="source">NotImplementedError.prototype.name = 'Not Implemented Error';</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source"> * Range Out Of Bounds Error - Used when a range of data is requested from a set</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source"> * which is outside of the bounds of that set.</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source"> * @param {String} msg A string representation of this NotImplementedError</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">103</td><td class="hits">1</td><td class="source">var RangeOutOfBoundsError = function (msg) {</td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="source">  RangeOutOfBoundsError.super_.call(this, msg, this.constructor);</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">};</td></tr><tr class="hit"><td class="line">106</td><td class="hits">1</td><td class="source">util.inherits(RangeOutOfBoundsError, AbstractError);</td></tr><tr class="hit"><td class="line">107</td><td class="hits">1</td><td class="source">RangeOutOfBoundsError.prototype.name = 'Range Out Of Bounds Error';</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">110</td><td class="hits">1</td><td class="source">module.exports = {</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">  Access: AccessError,</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">  DuplicateEntry: DuplicateEntryError,</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">  IllegalValue: IllegalValueError,</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">  NotAllowed: NotAllowedError,</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">  NotFound: NotFoundError,</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">  NotImplemented:NotImplementedError,</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">  RangeOutOfBounds:RangeOutOfBoundsError</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="lib/util/broadcast_middleware.js">lib/util/broadcast_middleware.js</h2><div id="stats" class="terrible"><div class="percentage">11%</div><div class="sloc">34</div><div class="hits">4</div><div class="misses">30</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Ravel</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright (c) 2014 Sean McIntyre &lt;s.mcintyre@xverba.ca&gt;</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> * Keeps clients aware of changes to application</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> * data model so that they can automatically refresh</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * their UI without the user having to make a</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * request for new information.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">var path = require('path');</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">module.exports = function(Ravel) {</td></tr><tr class="hit"><td class="line">16</td><td class="hits">7</td><td class="source">  return function(req, res, next) {</td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="source">    if (req.method === 'GET') {</td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">      next();</td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">      return;</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">    var doBroadcast = function(body) {</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">      //only broadcast stuff when the endpoint successfully returned</td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">      if (body &amp;&amp; (res.statusCode === 200 || res.statusCode === 201)) {</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">        var crudEvent;</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        //translate method into event</td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="source">        switch (req.method) {</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">          case 'POST':</td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">            crudEvent = 'create';</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">            break;</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">          case 'PUT':</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">            crudEvent = 'change';</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">            break;</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">          case 'DELETE':</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">            crudEvent = 'delete';</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">            break;</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">          default:</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">            //do nothing;</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">            break;</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">        //determine room to broadcast to</td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">        var route = req.route.path;</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">        var routeComponents = route.split('/');</td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">        if (routeComponents.length &gt; 1 &amp;&amp; routeComponents[routeComponents.length-1][0] === ':') {</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">          //then the last component is a parameter, and we should</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">          //consider the 'resource' to be the route without that</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">          //parameter</td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="source">          route = '/' + path.join.apply(path.join, routeComponents.splice(0,routeComponents.length-1));</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">        }  else {</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">          crudEvent += ' all';</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">        var data = body;</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">        var jsonProtection = data.match(/^\)\]}'\,\n(.*)/);</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">        if (jsonProtection) {</td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">          data = jsonProtection[1];</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">        Ravel.broadcast.emit(route, crudEvent, data);</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">    //override all express methods which send something in a response</td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="source">    var buildOverrideSender = function(fToOverride) {</td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="source">      return function(body) {</td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="source">        doBroadcast(body);</td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="source">        fToOverride.apply(res, [body]);</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">      };</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">    //all express response methods (send, json, jsonp) go through end()</td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="source">    res.end = buildOverrideSender(res.end);</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="source">    next();</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="lib/util/injector.js">lib/util/injector.js</h2><div id="stats" class="low"><div class="percentage">27%</div><div class="sloc">18</div><div class="hits">5</div><div class="misses">13</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Ravel</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright (c) 2014 Sean McIntyre &lt;s.mcintyre@xverba.ca&gt;</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">var prototype = require('prototype');</td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">Object.extend(global, prototype);</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> * @param {Object} Ravel a reference to the current Ravel</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> * @param {Array} moduleFactories a list of registered module factories which haven't yet been instantiated</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> * @param {Object} requireModule the module to run require()s relative to, if a client tries to inject an NPM dependency</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">module.exports = function(Ravel, moduleFactories, requireModule) {</td></tr><tr class="hit"><td class="line">16</td><td class="hits">7</td><td class="source">  return {</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    inject: function(moduleMap, injectionFunction) {</td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">      moduleMap['$E'] = Ravel.ApplicationError;</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">      var requestedModules = injectionFunction.argumentNames();</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">      var args = [];</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">      for (var i=0;i&lt;requestedModules.length;i++) {</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">        if (moduleMap[requestedModules[i]] !== undefined) {</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">          //if the requested module is in our map of predefined valid stuff</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">          args.push(moduleMap[requestedModules[i]]);</td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">        } else if (moduleFactories[requestedModules[i]] !== undefined) {</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">          //if the requested module is a registered module</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">          args.push(Ravel.modules[requestedModules[i]]);</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">          try {</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">            var requiredModule = requireModule.require(requestedModules[i]);</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">            args.push(requiredModule);</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">          } catch (e) {</td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">            throw new Ravel.ApplicationError.NotFound('Unable to inject requested module \'' + requestedModules[i] + '\'. If it is one of your modules, make sure you register it with Ravel.module before running Ravel.start. If it is an NPM dependency, make sure it is in your package.json and that it has been installed via $ npm install.');</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">      injectionFunction.apply(injectionFunction, args);</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="lib/util/log.js">lib/util/log.js</h2><div id="stats" class="low"><div class="percentage">36%</div><div class="sloc">11</div><div class="hits">4</div><div class="misses">7</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Ravel</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright (c) 2014 Sean McIntyre &lt;s.mcintyre@xverba.ca&gt;</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">module.exports = function(source) {</td></tr><tr class="hit"><td class="line">9</td><td class="hits">7</td><td class="source">  return {</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">      l: function(message) {</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">        if (process.env.VERBOSE) {</td></tr><tr class="miss"><td class="line">12</td><td class="hits">0</td><td class="source">          console.log(source + ' [VERBOSE]: ' + message);</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">      i: function(message) {</td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="source">        if (process.env.VERBOSE || process.env.INFO) {</td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="source">          console.info(source + ' [INFO]: ' + message);</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">      w: function(message) {</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">        if (process.env.VERBOSE || process.env.INFO || process.env.WARNING) {</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">          console.warn(source + ' [WARNING]: ' + message);</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">      e: function(message) {</td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">        if (process.env.VERBOSE || process.env.INFO || process.env.WARNING || process.env.ERROR) {</td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="source">          console.error(source + ' [ERROR]: ' + message);</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="lib/util/rest.js">lib/util/rest.js</h2><div id="stats" class="terrible"><div class="percentage">7%</div><div class="sloc">55</div><div class="hits">4</div><div class="misses">51</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">'use strict';</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Ravel</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright (c) 2014 Sean McIntyre &lt;s.mcintyre@xverba.ca&gt;</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">module.exports = function(Ravel) {</td></tr><tr class="hit"><td class="line">9</td><td class="hits">7</td><td class="source">  var scope = {</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">    OK:200,</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">    CREATED:201,</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">    NO_CONTENT:204,</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    PARTIAL_CONTENT:206,</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    UNAUTHORIZED:401,</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    FORBIDDEN:403,</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    NOT_FOUND:404,</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    METHOD_NOT_ALLOWED:405,</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    CONFLICT:409,</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    REQUESTED_RANGE_NOT_SATISFIABLE:416,</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    INTERNAL_SERVER_ERROR:500,</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    NOT_IMPLEMENTED:501,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">     * Translates API JavaScript errors into equivalent HTTP response codes, and/or</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">     * packages the result of the API call into the response.</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">     * @param {Object} req Express.js request</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">     * @param {Object} res Express.js response</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">     * @param {Object | null} err Error object from API, or null</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">     * @param {Object | undefined} result the JSON payload to send in the reponse</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">     * @param {Object | undefined} Desired 'success' response code (20x) to send if</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">     *                             there are no API errors. 200 OK by default.</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">     * @param {Object} options any extra data</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">     */</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">    buildRestResponse: function(req, res, err, result, okCode, options) {</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">      if (okCode === undefined) {</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">        if (result) {</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">          okCode = scope.OK;</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">          okCode = scope.NO_CONTENT;</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">      } else if (okCode === scope.CREATED &amp;&amp; result &amp;&amp; result.id) {</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">        //try to set location header if we're creating something</td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">        res.location(req.headers.origin+req.url+result.id);</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">      } else if (okCode === scope.PARTIAL_CONTENT &amp;&amp; result) {</td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="source">        res.setHeader('Content-Range', 'items '+options.start+'-'+options.end+'/'+options.count);</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">      if (err) {</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">        if (err instanceof Ravel.ApplicationError.NotFound) {</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">          res.status(scope.NOT_FOUND).end();</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">        } else if (err instanceof Ravel.ApplicationError.Access) {</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">          res.status(scope.FORBIDDEN).end();</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">        } else if (err instanceof Ravel.ApplicationError.NotAllowed) {</td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">          res.status(scope.METHOD_NOT_ALLOWED).end();</td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">        } else if (err instanceof Ravel.ApplicationError.NotImplemented) {</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">          res.status(scope.NOT_IMPLEMENTED).end();</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">        } else if (err instanceof Ravel.ApplicationError.DuplicateEntry) {</td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">          res.status(scope.CONFLICT).end();</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">        } else if (err instanceof Ravel.ApplicationError.RangeOutOfBounds) {</td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">          res.status(scope.REQUESTED_RANGE_NOT_SATISFIABLE).end();</td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="source">        } else if (err instanceof Ravel.ApplicationError.IllegalValue) {</td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="source">          res.status(scope.INTERNAL_SERVER_ERROR).end();</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="source">          console.error(err.message);</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">          res.status(scope.INTERNAL_SERVER_ERROR).end();</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">      } else {</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">        //protect against JSON vulnerability</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">        //http://haacked.com/archive/2008/11/20/anatomy-of-a-subtle-json-vulnerability.aspx/</td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="source">        if (Ravel.get('disable json vulnerability protection')) {</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">          res.status(okCode).send(result);</td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="source">        } else if (result) {</td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="source">          var prefixed = ')]}\',\n' + JSON.stringify(result);</td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="source">          res.status(okCode).send(prefixed);</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="source">          res.status(okCode).end();</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">     * Super-useful function for handling range-compatible GET requests on</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">     * collections - but it only works if you write the API calls to support it.</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">     * @param {Object} req Express.js request</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">     * @param {Object} res Express.js response</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">     * @param {Function} totalCountFn a function which accepts the arguments</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">     *                   in idArgs, followed by a callback(err, {Number})</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">     * @param {Function} getFn a function which accepts the arguments in idArgs,</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">     *                   followed by a {Number} start, a {Number} end, and a</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">     *                   callback(err, {Array})</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">     * @param {Array} idArgs an array of arguments which uniquely identifies the</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">     *                collection in question and can be supplied to both</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">     *                totalCountFn and getFn</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">     */</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">    handleRangeGet: function(req, res, totalCountFn, getFn, idArgs) {</td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="source">      var rest = module.exports;</td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="source">      if (req.headers['Range']) {</td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="source">        var totalCountArgs = idArgs.slice(0); //clone array</td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="source">        totalCountArgs.push(function(err, count) {</td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="source">          var range = req.range(count);</td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="source">          if (!range) {</td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="source">            idArgs.push(</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">              0,</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">              1,</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">              function(err, result) {</td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="source">                scope.buildRestResponse(req, res, err, result);</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">              }</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">            );</td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="source">            getFn.apply(this, idArgs);</td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="source">          } else if (range === -1) {</td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="source">            scope.buildRestResponse(req, res, new Ravel.ApplicationError.RangeOutOfBounds(), undefined);</td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="source">          } else if (range === -2) {</td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="source">            scope.buildRestResponse(req, res, new Ravel.ApplicationError.RangeOutOfBounds(), undefined);</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">          } else {</td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="source">            idArgs.push(</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">              range[0].start,</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">              range[0].end,</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">              function(err, result) {</td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="source">                scope.buildRestResponse(req, res, err, result, rest.PARTIAL_CONTENT, {start:range[0].start, end:range[0].end, count:count});</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">              }</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">            );</td></tr><tr class="miss"><td class="line">124</td><td class="hits">0</td><td class="source">            getFn.apply(this, idArgs);</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">        });</td></tr><tr class="miss"><td class="line">127</td><td class="hits">0</td><td class="source">        totalCountFn.apply(this, totalCountArgs);</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">129</td><td class="hits">0</td><td class="source">        idArgs.push(</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">          undefined,</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">          undefined,</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">          function(err, result) {</td></tr><tr class="miss"><td class="line">133</td><td class="hits">0</td><td class="source">            scope.buildRestResponse(req, res, err, result);</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">        );</td></tr><tr class="miss"><td class="line">136</td><td class="hits">0</td><td class="source">        getFn.apply(this, idArgs);</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">141</td><td class="hits">7</td><td class="source">  return scope;</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div></div></div></body></html>